# openhab-persistence-export

A small web-based wizard to download [openHAB](https://www.openhab.org) persistence data from a given date range as CSV or JSON.
Using vanilla JavaScript and Parcel for bundling, the deployed app is fully static, self-contained, and has no external dependencies.

## Usage

> [!NOTE]
> This app assumes that _Implicit User-Role_ is enabled in the _API Security_ settings of openHAB.
> It does not implement authentication.

1. Create a `persistence-export` folder in `$OPENHAB_CONF/html`.
1. `cd` into the newly created folder.
1. Select a release version from the [releases page](https://github.com/florian-h05/openhab-persistence-export/releases).
1. Download and extract the release tarball, remember to set `RELEASE` to the desired version:
   ```shell
   RELEASE=1.0.0 curl -L https://github.com/florian-h05/openhab-persistence-export/releases/download/v$RELEASE/dist-v$RELEASE.tar.gz | tar -xz --strip-components=1 -C .
   ```

You can now access the app at `http://<openhab-host>:8080/static/persistence-export/index.html`.
The `itemname` query parameter can be used to pre-select an Item: `http://<openhab-host>:8080/static/persistence-export/index.html?itemname=Florian_Temperatur`.

### CSV Export Example

Below is a small sample CSV that demonstrates the format produced by the app (UTC and local timestamps, value and unit):

```csv
Item Name,UTC Time,Local Time,Value,Unit
Florian_Temperatur,2025-10-19T00:00:00.555Z,2025-10-19T02:00:00+02:00,20.5,°C
Florian_Temperatur,2025-10-19T00:05:00.550Z,2025-10-19T02:05:00+02:00,20.5,°C
Florian_Temperatur,2025-10-19T00:09:17.018Z,2025-10-19T02:09:17+02:00,20.6,°C
Florian_Temperatur,2025-10-19T00:10:00.548Z,2025-10-19T02:10:00+02:00,20.6,°C
Florian_Temperatur,2025-10-19T00:15:00.554Z,2025-10-19T02:15:00+02:00,20.6,°C
Florian_Temperatur,2025-10-19T00:20:00.549Z,2025-10-19T02:20:00+02:00,20.7,°C
Florian_Temperatur,2025-10-19T00:25:00.543Z,2025-10-19T02:25:00+02:00,20.7,°C
Florian_Temperatur,2025-10-19T00:30:00.527Z,2025-10-19T02:30:00+02:00,20.6,°C
Florian_Temperatur,2025-10-19T00:35:00.534Z,2025-10-19T02:35:00+02:00,20.6,°C
Florian_Temperatur,2025-10-19T00:40:00.576Z,2025-10-19T02:40:00+02:00,20.5,°C
Florian_Temperatur,2025-10-19T00:45:00.525Z,2025-10-19T02:45:00+02:00,20.4,°C
Florian_Temperatur,2025-10-19T00:50:00.587Z,2025-10-19T02:50:00+02:00,20.3,°C
Florian_Temperatur,2025-10-19T00:55:00.550Z,2025-10-19T02:55:00+02:00,20.0,°C
Florian_Temperatur,2025-10-19T01:00:00.578Z,2025-10-19T03:00:00+02:00,20.0,°C
Florian_Temperatur,2025-10-19T01:05:00.578Z,2025-10-19T03:05:00+02:00,19.8,°C
Florian_Temperatur,2025-10-19T01:10:00.556Z,2025-10-19T03:10:00+02:00,20.2,°C
Florian_Temperatur,2025-10-19T01:15:00.523Z,2025-10-19T03:15:00+02:00,20.2,°C
Florian_Temperatur,2025-10-19T01:20:00.536Z,2025-10-19T03:20:00+02:00,20.5,°C
```

## Development

### Prerequisites

1. Node.js (24+ recommended) and npm
1. A running openHAB instance reachable on localhost (or via port forwarding if not on the same host)
1. Install dependencies:
   ```shell
   npm install
   ```

### NPM Scripts

- `npm run dev` - Start Parcel dev server and open the app in the default browser.
- `npm run build` - Build an optimised production bundle into `dist/`.
- `npm run preview` - Serve the production build locally.
- `npm run lint` - Run ESLint to find problems in the JavaScript source code.
- `npm run lint:fix` - Run ESLint to automatically fix problems reported by `npm run lint`..
- `npm run format` - Run Prettier to format source files.

### Dependencies

- [flatpickr](https://flatpickr.js.org/) — used for date/time picking in the UI.
- dev: [Parcel](https://parceljs.org/), [ESLint](https://eslint.org/), [Prettier](https://prettier.io/), and supporting packages.

### Project Structure

```
dist/          # generated by build (ignored/generated)
app.js         # application logic (entry)
index.html     # main HTML bootstrap
lib.js         # helper functions
package.json   # npm metadata and scripts
style.css      # app styles

README.md      # (this file)
```

Files named above may contain the following responsibilities:

- `index.html` — app container and script/style includes
- `app.js` — UI wiring, fetches openHAB items and persistence data, calls helper functions, triggers downloads
- `lib.js` — utility helpers (e.g. CSV escaping, date formatting, download helper, API helpers)
- `style.css` — styling for the wizard UI

### How the app works (high-level)

1. The UI fetches the available items from the openHAB REST API (`/rest/items`).
2. You select item(s), persistence service, and a time range via Flatpickr date/time pickers.
3. When you trigger an export, the app queries the persistence API endpoints (for example `/rest/persistence/items/<item>/...`) and collects the data.
4. The app formats the data as CSV (or JSON if supported) and triggers a download in the browser.

## Contribution

Contributions are welcome.
Open issues or pull requests with minimal, focused changes.
Follow the existing code style (Prettier + ESLint).

## License

MIT — see `package.json` for metadata.
